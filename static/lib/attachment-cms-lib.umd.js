var te=Object.defineProperty;var ne=(a,o,d)=>o in a?te(a,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):a[o]=d;var f=(a,o,d)=>(ne(a,typeof o!="symbol"?o+"":o,d),d);(function(a,o){typeof exports=="object"&&typeof module!="undefined"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(a=typeof globalThis!="undefined"?globalThis:a||self,o(a.AttachmentCMS={}))})(this,function(a){"use strict";var o=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},d="Expected a function",C=0/0,$="[object Symbol]",B=/^\s+|\s+$/g,O=/^[-+]0x[0-9a-f]+$/i,H=/^0b[01]+$/i,R=/^0o[0-7]+$/i,q=parseInt,P=typeof o=="object"&&o&&o.Object===Object&&o,N=typeof self=="object"&&self&&self.Object===Object&&self,U=P||N||Function("return this")(),_=Object.prototype,F=_.toString,D=Math.max,W=Math.min,T=function(){return U.Date.now()};function G(n,e,t){var r,i,h,m,c,u,p=0,M=!1,y=!1,v=!0;if(typeof n!="function")throw new TypeError(d);e=x(e)||0,g(t)&&(M=!!t.leading,y="maxWait"in t,h=y?D(x(t.maxWait)||0,e):h,v="trailing"in t?!!t.trailing:v);function E(s){var l=r,b=i;return r=i=void 0,p=s,m=n.apply(b,l),m}function V(s){return p=s,c=setTimeout(w,e),M?E(s):m}function Y(s){var l=s-u,b=s-p,I=e-l;return y?W(I,h-b):I}function j(s){var l=s-u,b=s-p;return u===void 0||l>=e||l<0||y&&b>=h}function w(){var s=T();if(j(s))return A(s);c=setTimeout(w,Y(s))}function A(s){return c=void 0,v&&r?E(s):(r=i=void 0,m)}function Z(){c!==void 0&&clearTimeout(c),p=0,r=u=i=c=void 0}function ee(){return c===void 0?m:A(T())}function k(){var s=T(),l=j(s);if(r=arguments,i=this,u=s,l){if(c===void 0)return V(u);if(y)return c=setTimeout(w,e),E(u)}return c===void 0&&(c=setTimeout(w,e)),m}return k.cancel=Z,k.flush=ee,k}function Q(n,e,t){var r=!0,i=!0;if(typeof n!="function")throw new TypeError(d);return g(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),G(n,e,{leading:r,maxWait:e,trailing:i})}function g(n){var e=typeof n;return!!n&&(e=="object"||e=="function")}function X(n){return!!n&&typeof n=="object"}function z(n){return typeof n=="symbol"||X(n)&&F.call(n)==$}function x(n){if(typeof n=="number")return n;if(z(n))return C;if(g(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=g(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=n.replace(B,"");var t=H.test(n);return t||R.test(n)?q(n.slice(2),t?2:8):O.test(n)?C:+n}var J=Q;function K(){window.history.pushState=new Proxy(window.history.pushState,{apply:(n,e,t)=>{const r=new Event("pushstate"),i=n.apply(e,t);return window.dispatchEvent(r),i}}),window.history.replaceState=new Proxy(window.history.replaceState,{apply:(n,e,t)=>{const r=new Event("replacestate"),i=n.apply(e,t);return window.dispatchEvent(r),i}})}const S="acms-content";class L{constructor(e){f(this,"baseUrl");f(this,"defaultToken");f(this,"queryToken");f(this,"contents");f(this,"id");f(this,"contentsResponse");f(this,"throttleApplyContents");if(!e||!e.token)throw new Error("Required acmst query parameter as token.");this.baseUrl=e&&e.baseUrl||"https://api.attachment-cms.dev",this.defaultToken=e.token,this.id=e&&e.id||null,this.throttleApplyContents=J(this.applyContents,e&&e.throttleMs||200)}get isClient(){return typeof window=="undefined"}get url(){return this.queryToken?`${this.baseUrl}/contents/limited`:`${this.baseUrl}/contents`}get token(){return this.queryToken||this.defaultToken}async run(){this.isClient||(this.queryToken=this.getQueryToken(),this.showLimitedMode(),this.contentsResponse=await this.fetchContents(),this.contents=this.extractMatchedContents(this.contentsResponse.contents),document.readyState==="loading"?window.addEventListener("DOMContentLoaded",()=>{this.applyContents(),this.observeElement(),this.observeHistoryState()}):(this.applyContents(),this.observeElement(),this.observeHistoryState()))}getQueryToken(){let e=sessionStorage.getItem("acmst");return e||(e=new URLSearchParams(window.location.search).get("acmst"),e&&sessionStorage.setItem("acmst",e),e)}showLimitedMode(){if(!this.queryToken)return;const e=document.getElementsByTagName("body")[0],t=`<div id="${S}-limited-mark" style="position: fixed; bottom: 20px; right: 30px;background-color: #46F28D; box-shadow: 0 10px 25px 0 rgba(0, 0, 0, .5); border-radius: 6px;">
    <p style="padding: 10px; font-weight: 600;">\u9650\u5B9A\u516C\u958B<br/>by attachment CMS</p>
    </div>`;this.insertLastChildToElement(e,t)}async fetchContents(){const e=`${this.url}?token=${this.token}`;return(await fetch(e)).json()}extractMatchedContents(e){if(!e)return[];const t=Object.keys(e),r=window.location.pathname.replace(/\/$/,"");return t.filter(i=>{i=i.replace(/\/$/,"");const h=new RegExp(String.raw`^${i}$`,"i");return r.match(h)}).map(i=>e[i]).flat()}observeElement(){const e=this.id?document.getElementById(this.id):document.getElementsByTagName("body")[0];if(!e)throw this.id&&console.warn(`No exists html element. id: ${this.id}`),new Error("No found observed element.");const t=new MutationObserver(()=>{this.throttleApplyContents()}),r={attributes:!1,characterData:!0,childList:!0,subtree:!0};t.observe(e,r)}applyContents(){this.contents.forEach(e=>{const t=document.querySelector(e.selector);if(!t)return;const r=`${S}-${e.id}`;if(!document.getElementById(r))switch(e.action){case"innerHTML":t.innerHTML=e.content;break;case"remove":this.removeElement(t,r);break;case"insertBefore":this.insertBeforeElement(t,e.content);break;case"insertChildAfterBegin":this.insertFirstChildToElement(t,e.content);break;case"insertChildBeforeEnd":this.insertLastChildToElement(t,e.content);break;case"insertAfter":this.insertAfterElement(t,e.content);break}})}removeElement(e,t){e.id=t,e.setAttribute("style","display: none;")}insertBeforeElement(e,t){e.insertAdjacentHTML("beforebegin",t)}insertFirstChildToElement(e,t){e.insertAdjacentHTML("afterbegin",t)}insertLastChildToElement(e,t){e.insertAdjacentHTML("beforeend",t)}insertAfterElement(e,t){e.insertAdjacentHTML("afterend",t)}observeHistoryState(){K();const e=()=>{this.contents=this.extractMatchedContents(this.contentsResponse.contents)};window.addEventListener("popstate",e),window.addEventListener("pushstate",e),window.addEventListener("replacestate",e)}}typeof window!="undefined"&&window.AttachmentConfig&&new L(window.AttachmentConfig).run(),a.AttachmentCMS=L,Object.defineProperty(a,"__esModule",{value:!0}),a[Symbol.toStringTag]="Module"});
