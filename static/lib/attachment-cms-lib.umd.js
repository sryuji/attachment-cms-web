var ee=Object.defineProperty;var te=(a,o,d)=>o in a?ee(a,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):a[o]=d;var f=(a,o,d)=>(te(a,typeof o!="symbol"?o+"":o,d),d);(function(a,o){typeof exports=="object"&&typeof module!="undefined"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(a=typeof globalThis!="undefined"?globalThis:a||self,o(a.AttachmentCMS={}))})(this,function(a){"use strict";var o=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},d="Expected a function",k=0/0,H="[object Symbol]",O=/^\s+|\s+$/g,I=/^[-+]0x[0-9a-f]+$/i,B=/^0b[01]+$/i,$=/^0o[0-7]+$/i,N=parseInt,R=typeof o=="object"&&o&&o.Object===Object&&o,q=typeof self=="object"&&self&&self.Object===Object&&self,P=R||q||Function("return this")(),U=Object.prototype,F=U.toString,W=Math.max,_=Math.min,T=function(){return P.Date.now()};function D(n,e,t){var i,s,h,m,c,u,p=0,S=!1,y=!1,v=!0;if(typeof n!="function")throw new TypeError(d);e=x(e)||0,g(t)&&(S=!!t.leading,y="maxWait"in t,h=y?W(x(t.maxWait)||0,e):h,v="trailing"in t?!!t.trailing:v);function C(r){var l=i,b=s;return i=s=void 0,p=r,m=n.apply(b,l),m}function K(r){return p=r,c=setTimeout(w,e),S?C(r):m}function V(r){var l=r-u,b=r-p,A=e-l;return y?_(A,h-b):A}function M(r){var l=r-u,b=r-p;return u===void 0||l>=e||l<0||y&&b>=h}function w(){var r=T();if(M(r))return j(r);c=setTimeout(w,V(r))}function j(r){return c=void 0,v&&i?C(r):(i=s=void 0,m)}function Y(){c!==void 0&&clearTimeout(c),p=0,i=u=s=c=void 0}function Z(){return c===void 0?m:j(T())}function E(){var r=T(),l=M(r);if(i=arguments,s=this,u=r,l){if(c===void 0)return K(u);if(y)return c=setTimeout(w,e),C(u)}return c===void 0&&(c=setTimeout(w,e)),m}return E.cancel=Y,E.flush=Z,E}function G(n,e,t){var i=!0,s=!0;if(typeof n!="function")throw new TypeError(d);return g(t)&&(i="leading"in t?!!t.leading:i,s="trailing"in t?!!t.trailing:s),D(n,e,{leading:i,maxWait:e,trailing:s})}function g(n){var e=typeof n;return!!n&&(e=="object"||e=="function")}function Q(n){return!!n&&typeof n=="object"}function X(n){return typeof n=="symbol"||Q(n)&&F.call(n)==H}function x(n){if(typeof n=="number")return n;if(X(n))return k;if(g(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=g(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=n.replace(O,"");var t=B.test(n);return t||$.test(n)?N(n.slice(2),t?2:8):I.test(n)?k:+n}var z=G;function J(){window.history.pushState=new Proxy(window.history.pushState,{apply:(n,e,t)=>{const i=new Event("pushstate"),s=n.apply(e,t);return window.dispatchEvent(i),s}}),window.history.replaceState=new Proxy(window.history.replaceState,{apply:(n,e,t)=>{const i=new Event("replacestate"),s=n.apply(e,t);return window.dispatchEvent(i),s}})}class L{constructor(e){f(this,"baseUrl");f(this,"defaultToken");f(this,"queryToken");f(this,"contents");f(this,"id");f(this,"contentsResponse");f(this,"throttleApplyContents");if(!e||!e.token)throw new Error("Required acmst query parameter as token.");this.baseUrl=e&&e.baseUrl||"https://api.attachment-cms.dev",this.defaultToken=e.token,this.id=e&&e.id||null,this.throttleApplyContents=z(this.applyContents,200)}get isClient(){return typeof window=="undefined"}get url(){return this.queryToken?`${this.baseUrl}/contents/limited`:`${this.baseUrl}/contents`}get token(){return this.queryToken||this.defaultToken}async run(){this.isClient||(this.queryToken=this.getQueryToken(),this.showLimitedMode(),this.contentsResponse=await this.fetchContents(),this.contents=this.extractMatchedContents(this.contentsResponse.contents),document.readyState==="loading"?window.addEventListener("DOMContentLoaded",()=>{this.applyContents(),this.observeElement(),this.observeHistoryState()}):(this.applyContents(),this.observeElement(),this.observeHistoryState()))}getQueryToken(){let e=sessionStorage.getItem("acmst");return e||(e=new URLSearchParams(window.location.search).get("acmst"),e&&sessionStorage.setItem("acmst",e),e)}showLimitedMode(){if(!this.queryToken)return;const e=document.getElementsByTagName("body")[0],t=`<div style="position: fixed; bottom: 20px; right: 30px;background-color: #46F28D; box-shadow: 0 10px 25px 0 rgba(0, 0, 0, .5); border-radius: 6px;">
    <p style="padding: 10px; font-weight: 600;">\u9650\u5B9A\u516C\u958B<br/>by attachment CMS</p>
    </div>`;this.insertLastChildToElement(e,t)}async fetchContents(){const e=`${this.url}?token=${this.token}`;return(await fetch(e)).json()}extractMatchedContents(e){if(!e)return[];const t=Object.keys(e),i=window.location.pathname;return t.filter(s=>{const h=new RegExp(String.raw`^${s}$`,"i");return i.match(h)}).map(s=>e[s]).flat()}observeElement(){if(!(this.id?document.getElementById(this.id):document.getElementsByTagName("body")[0]))throw this.id&&console.warn(`No exists html element. id: ${this.id}`),new Error("No found observed element.");const t=new MutationObserver(()=>{this.throttleApplyContents()}),i={attributes:!1,characterData:!0,childList:!0,subtree:!0};t.observe(document,i)}applyContents(){this.contents.forEach(e=>{const t=document.querySelector(e.selector);if(!!t)switch(e.content&&!e.content.startsWith("<")&&(e.content=`<div>${e.content}</div>`),e.action){case"innerHTML":if(t.innerHTML===e.content)return;t.innerHTML=e.content;break;case"remove":t.parentNode.removeChild(t);break;case"insertBefore":this.insertBeforeElement(t,e.content);break;case"insertChildAfterBegin":this.insertFirstChildToElement(t,e.content);break;case"insertChildBeforeEnd":this.insertLastChildToElement(t,e.content);break;case"insertAfter":this.insertAfterElement(t,e.content);break}})}insertBeforeElement(e,t){const i=e.previousSibling;i&&i.innerHTML===t||e.insertAdjacentHTML("beforebegin",t)}insertFirstChildToElement(e,t){const i=e.firstChild;i&&i.innerHTML===t||e.insertAdjacentHTML("afterbegin",t)}insertLastChildToElement(e,t){const i=e.lastChild;i&&i.innerHTML===t||e.insertAdjacentHTML("beforeend",t)}insertAfterElement(e,t){const i=e.lastChild;i&&i.innerHTML===t||e.insertAdjacentHTML("afterend",t)}observeHistoryState(){J();const e=()=>{this.contents=this.extractMatchedContents(this.contentsResponse.contents)};window.addEventListener("popstate",e),window.addEventListener("pushstate",e),window.addEventListener("replacestate",e)}}typeof window!="undefined"&&window.AttachmentConfig&&new L(window.AttachmentConfig).run(),a.AttachmentCMS=L,Object.defineProperty(a,"__esModule",{value:!0}),a[Symbol.toStringTag]="Module"});
