var ne=Object.defineProperty;var re=(a,o,d)=>o in a?ne(a,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):a[o]=d;var u=(a,o,d)=>(re(a,typeof o!="symbol"?o+"":o,d),d);(function(a,o){typeof exports=="object"&&typeof module!="undefined"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(a=typeof globalThis!="undefined"?globalThis:a||self,o(a.AttachmentCMS={}))})(this,function(a){"use strict";var o=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},d="Expected a function",k=0/0,O="[object Symbol]",$=/^\s+|\s+$/g,B=/^[-+]0x[0-9a-f]+$/i,H=/^0b[01]+$/i,R=/^0o[0-7]+$/i,P=parseInt,N=typeof o=="object"&&o&&o.Object===Object&&o,q=typeof self=="object"&&self&&self.Object===Object&&self,_=N||q||Function("return this")(),U=Object.prototype,F=U.toString,D=Math.max,W=Math.min,T=function(){return _.Date.now()};function G(n,e,t){var r,i,l,m,c,h,p=0,M=!1,y=!1,v=!0;if(typeof n!="function")throw new TypeError(d);e=x(e)||0,g(t)&&(M=!!t.leading,y="maxWait"in t,l=y?D(x(t.maxWait)||0,e):l,v="trailing"in t?!!t.trailing:v);function E(s){var f=r,b=i;return r=i=void 0,p=s,m=n.apply(b,f),m}function V(s){return p=s,c=setTimeout(w,e),M?E(s):m}function Z(s){var f=s-h,b=s-p,I=e-f;return y?W(I,l-b):I}function j(s){var f=s-h,b=s-p;return h===void 0||f>=e||f<0||y&&b>=l}function w(){var s=T();if(j(s))return A(s);c=setTimeout(w,Z(s))}function A(s){return c=void 0,v&&r?E(s):(r=i=void 0,m)}function ee(){c!==void 0&&clearTimeout(c),p=0,r=h=i=c=void 0}function te(){return c===void 0?m:A(T())}function C(){var s=T(),f=j(s);if(r=arguments,i=this,h=s,f){if(c===void 0)return V(h);if(y)return c=setTimeout(w,e),E(h)}return c===void 0&&(c=setTimeout(w,e)),m}return C.cancel=ee,C.flush=te,C}function Q(n,e,t){var r=!0,i=!0;if(typeof n!="function")throw new TypeError(d);return g(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),G(n,e,{leading:r,maxWait:e,trailing:i})}function g(n){var e=typeof n;return!!n&&(e=="object"||e=="function")}function X(n){return!!n&&typeof n=="object"}function Y(n){return typeof n=="symbol"||X(n)&&F.call(n)==O}function x(n){if(typeof n=="number")return n;if(Y(n))return k;if(g(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=g(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=n.replace($,"");var t=H.test(n);return t||R.test(n)?P(n.slice(2),t?2:8):B.test(n)?k:+n}var z=Q;function J(){window.history.pushState=new Proxy(window.history.pushState,{apply:(n,e,t)=>{const r=new Event("pushstate"),i=n.apply(e,t);return window.dispatchEvent(r),i}}),window.history.replaceState=new Proxy(window.history.replaceState,{apply:(n,e,t)=>{const r=new Event("replacestate"),i=n.apply(e,t);return window.dispatchEvent(r),i}})}const S="acms-content",K=["PluginContentHistory","ReleaseContentHistory"];class L{constructor(e){u(this,"baseUrl");u(this,"defaultToken");u(this,"queryToken");u(this,"contents");u(this,"id");u(this,"contentsResponse");u(this,"throttleApplyContents");if(!e||!e.token)throw new Error("Required acmst query parameter as token.");this.baseUrl=e&&e.baseUrl||"https://api.attachment-cms.dev",this.defaultToken=e.token,this.id=e&&e.id||null,this.throttleApplyContents=z(this.applyContents,e&&e.throttleMs||200)}get isServer(){return typeof window=="undefined"}get url(){return this.queryToken?`${this.baseUrl}/contents/limited`:`${this.baseUrl}/contents`}get token(){return this.queryToken||this.defaultToken}async run(){this.isServer||(this.queryToken=this.getQueryToken(),this.showLimitedMode(),this.contentsResponse=await this.fetchContents(),this.contents=this.extractMatchedContents(this.contentsResponse.contents),document.readyState==="loading"?window.addEventListener("DOMContentLoaded",()=>{this.applyContents(),this.observeElement(),this.observeHistoryState()}):(this.applyContents(),this.observeElement(),this.observeHistoryState()))}load(e){if(!e||!e.contents)throw new Error("Need 1 argument. Please pass response data.");this.contentsResponse=e}pick(e){return Object.values(this.contentsResponse.contents).flat().find(r=>r.id===e)}getQueryToken(){let e=sessionStorage.getItem("acmst");return e||(e=new URLSearchParams(window.location.search).get("acmst"),e&&sessionStorage.setItem("acmst",e),e)}showLimitedMode(){if(!this.queryToken)return;const e=document.getElementsByTagName("body")[0],t=`<div id="${S}-limited-mark" style="position: fixed; bottom: 20px; right: 30px;background-color: #46F28D; box-shadow: 0 10px 25px 0 rgba(0, 0, 0, .5); border-radius: 6px;">
    <p style="padding: 10px; font-weight: 600;">\u9650\u5B9A\u516C\u958B<br/>by attachment CMS</p>
    </div>`;this.insertLastChildToElement(e,t)}async fetchContents(){const e=`${this.url}?token=${this.token}`;return(await fetch(e)).json()}extractMatchedContents(e){if(!e)return[];const t=Object.keys(e),r=window.location.pathname.replace(/\/$/,"");return t.filter(i=>{i=i.replace(/\/$/,"");const l=new RegExp(String.raw`^${i}$`,"i");return r.match(l)}).map(i=>e[i]).flat().sort((i,l)=>this.calcContentIndex(i.type)-this.calcContentIndex(l.type))}calcContentIndex(e){let t=K.indexOf(e);return t=t===-1?999:t,t}observeElement(){const e=this.id?document.getElementById(this.id):document.getElementsByTagName("body")[0];if(!e)throw this.id&&console.warn(`No exists html element. id: ${this.id}`),new Error("No found observed element.");const t=new MutationObserver(()=>{this.throttleApplyContents()}),r={attributes:!1,characterData:!0,childList:!0,subtree:!0};t.observe(e,r)}applyContents(){this.contents.forEach(e=>{const t=document.querySelector(e.selector);if(!t)return;const r=`${S}-${e.id}`;if(!document.getElementById(r))switch(e.action){case"innerHTML":t.innerHTML=e.content;break;case"remove":this.removeElement(t,r);break;case"insertBefore":this.insertBeforeElement(t,e.content);break;case"insertChildAfterBegin":this.insertFirstChildToElement(t,e.content);break;case"insertChildBeforeEnd":this.insertLastChildToElement(t,e.content);break;case"insertAfter":this.insertAfterElement(t,e.content);break}})}removeElement(e,t){e.id=t,e.setAttribute("style","display: none;")}insertBeforeElement(e,t){e.insertAdjacentHTML("beforebegin",t)}insertFirstChildToElement(e,t){e.insertAdjacentHTML("afterbegin",t)}insertLastChildToElement(e,t){e.insertAdjacentHTML("beforeend",t)}insertAfterElement(e,t){e.insertAdjacentHTML("afterend",t)}observeHistoryState(){J();const e=()=>{this.contents=this.extractMatchedContents(this.contentsResponse.contents)};window.addEventListener("popstate",e),window.addEventListener("pushstate",e),window.addEventListener("replacestate",e)}}typeof window!="undefined"&&window.AttachmentConfig&&new L(window.AttachmentConfig).run(),a.AttachmentCMS=L,Object.defineProperty(a,"__esModule",{value:!0}),a[Symbol.toStringTag]="Module"});
